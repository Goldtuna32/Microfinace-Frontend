"use strict";(self.webpackChunkskeleton=self.webpackChunkskeleton||[]).push([[14],{6014:(q,C,u)=>{u.r(C),u.d(C,{LoanCreateComponent:()=>x});var f=u(177),l=u(9417),e=u(4438),F=u(2425),v=u(7309),b=u(8498);const I=()=>({standalone:!0});function k(n,i){if(1&n){const t=e.RV6();e.j41(0,"div",31),e.EFF(1," Loan registered successfully! "),e.j41(2,"button",32),e.bIt("click",function(){e.eBV(t);const o=e.XpG();return e.Njj(o.showSuccessMessage=!1)}),e.k0s()()}}function E(n,i){if(1&n&&(e.j41(0,"div",33),e.EFF(1),e.k0s()),2&n){const t=e.XpG();e.R7$(),e.SpI(" ",t.errorMessage," ")}}function y(n,i){if(1&n){const t=e.RV6();e.j41(0,"div",37),e.bIt("click",function(){const o=e.eBV(t).$implicit,a=e.XpG(2);return e.Njj(a.selectCif(o))}),e.EFF(1),e.k0s()}if(2&n){const t=i.$implicit;e.R7$(),e.Lme(" ",t.serialNumber," - ",t.name," ")}}function D(n,i){1&n&&(e.j41(0,"div",38),e.EFF(1," No matching CIFs found "),e.k0s())}function N(n,i){if(1&n&&(e.j41(0,"div",34),e.DNE(1,y,2,2,"div",35)(2,D,2,0,"div",36),e.k0s()),2&n){const t=e.XpG();e.R7$(),e.Y8G("ngForOf",t.filteredCifs),e.R7$(),e.Y8G("ngIf",0===t.filteredCifs.length)}}function j(n,i){1&n&&(e.j41(0,"div",10),e.EFF(1," CIF is required "),e.k0s())}function R(n,i){if(1&n&&(e.j41(0,"option",39),e.EFF(1),e.k0s()),2&n){const t=i.$implicit;e.Y8G("value",t.id),e.R7$(),e.SpI(" ",t.accountNumber," ")}}function A(n,i){1&n&&(e.j41(0,"div",10),e.EFF(1," Current account is required "),e.k0s())}function L(n,i){if(1&n&&(e.j41(0,"option",39),e.EFF(1),e.nI1(2,"currency"),e.k0s()),2&n){const t=i.$implicit;e.Y8G("value",t.id),e.R7$(),e.Lme(" ",t.description," (",e.bMT(2,3,t.value),") ")}}function M(n,i){if(1&n){const t=e.RV6();e.j41(0,"div",45)(1,"button",46),e.bIt("click",function(){e.eBV(t);const o=e.XpG(2);return e.Njj(o.addCollateral())}),e.EFF(2,"+"),e.k0s()()}}function S(n,i){if(1&n){const t=e.RV6();e.j41(0,"div",40)(1,"select",41)(2,"option",16),e.EFF(3,"-- Select Collateral --"),e.k0s(),e.DNE(4,L,3,5,"option",17),e.k0s(),e.j41(5,"span",42),e.EFF(6),e.nI1(7,"currency"),e.k0s(),e.j41(8,"button",43),e.bIt("click",function(){const o=e.eBV(t).index,a=e.XpG();return e.Njj(a.removeCollateral(o))}),e.EFF(9," - "),e.k0s(),e.DNE(10,M,3,0,"div",44),e.k0s()}if(2&n){const t=i.$implicit,r=i.index,o=e.XpG();e.Y8G("formGroupName",r),e.R7$(4),e.Y8G("ngForOf",o.getAvailableCollaterals(r)),e.R7$(2),e.SpI(" ",e.bMT(7,5,o.getCollateralValue(t))," "),e.R7$(2),e.Y8G("disabled",1===o.collateralControls.length),e.R7$(2),e.Y8G("ngIf",r===o.collateralControls.length-1)}}function T(n,i){1&n&&(e.j41(0,"div",10),e.EFF(1," At least one valid collateral is required "),e.k0s())}function G(n,i){1&n&&(e.j41(0,"div",10),e.EFF(1," Loan amount is required and must be greater than 0 "),e.k0s())}function w(n,i){1&n&&(e.j41(0,"div",10),e.EFF(1," Interest rate is required and must be greater than 0 "),e.k0s())}function O(n,i){1&n&&(e.j41(0,"div",10),e.EFF(1," Grace period is required and must be 0 or greater "),e.k0s())}function $(n,i){1&n&&(e.j41(0,"div",10),e.EFF(1," Repayment duration is required and must be greater than 0 "),e.k0s())}function P(n,i){1&n&&(e.j41(0,"div",10),e.EFF(1," Document fee is required and must be greater than 0 "),e.k0s())}function Y(n,i){1&n&&(e.j41(0,"div",10),e.EFF(1," Service charges are required and must be greater than 0 "),e.k0s())}let x=(()=>{class n{constructor(t,r,o,a,s){this.fb=t,this.collateralService=r,this.loanService=o,this.router=a,this.cdr=s,this.cifs=[],this.filteredCifs=[],this.currentAccounts=[],this.collaterals=[],this.showSuccessMessage=!1,this.errorMessage=null,this.showCifDropdown=!1,this.cifSearchInput=""}ngOnInit(){this.initForm(),this.loadCifs()}initForm(){this.loanForm=this.fb.group({cifId:["",l.k0.required],currentAccountId:["",l.k0.required],loanAmount:["",[l.k0.required,l.k0.min(0)]],interestRate:["",[l.k0.required,l.k0.min(0)]],gracePeriod:["",[l.k0.required,l.k0.min(0)]],repaymentDuration:["",[l.k0.required,l.k0.min(1)]],documentFee:["",[l.k0.required,l.k0.min(0)]],serviceCharges:["",[l.k0.required,l.k0.min(0)]],status:[1,l.k0.required],dueDate:[""],repaymentStartDate:[""],collaterals:this.fb.array([this.createCollateralGroup()])}),this.loanForm.get("collaterals").valueChanges.subscribe(()=>this.updateTotalCollateralAmount())}createCollateralGroup(){return this.fb.group({collateralId:["",l.k0.required]})}get collateralControls(){return this.loanForm.get("collaterals").controls}get totalCollateralAmount(){return this.collateralControls.reduce((t,r)=>{const o=Number(r.get("collateralId")?.value),a=this.collaterals.find(s=>s.id===o);return t+(a?Number(a.value):0)},0)}getCollateralValue(t){const r=Number(t.get("collateralId")?.value),o=this.collaterals.find(a=>a.id===r);return o?Number(o.value):void 0}getAvailableCollaterals(t){const r=this.collateralControls.filter((o,a)=>a!==t).map(o=>Number(o.get("collateralId")?.value)).filter(o=>o);return this.collaterals.filter(o=>!r.includes(o.id))}addCollateral(){this.loanForm.get("collaterals").push(this.createCollateralGroup())}removeCollateral(t){const r=this.loanForm.get("collaterals");r.length>1&&r.removeAt(t)}loadCifs(){this.collateralService.getAllCifs().subscribe({next:t=>{console.log("CIFs Loaded:",t),this.cifs=t,this.filteredCifs=t.slice(0,10)},error:t=>this.errorMessage="Failed to load CIFs: "+t.message})}filterCifs(t){const r=t.target;if(r){this.cifSearchInput=r.value;const o=this.cifSearchInput.toLowerCase();this.filteredCifs=this.cifs.filter(a=>(a.serialNumber||"").toLowerCase().includes(o)).slice(0,10),this.showCifDropdown=!0}}selectCif(t){console.log("Selected CIF:",t),this.cifSearchInput=t.serialNumber||"",this.loanForm.patchValue({cifId:t.id}),this.showCifDropdown=!1,this.loadCurrentAccountsByCifId(t.id),this.loadCollaterals(t.id)}toggleCifDropdown(){this.showCifDropdown=!this.showCifDropdown,this.showCifDropdown&&!this.cifSearchInput&&(this.filteredCifs=this.cifs.slice(0,10))}closeDropdowns(){setTimeout(()=>{this.showCifDropdown=!1},200)}loadCurrentAccountsByCifId(t){console.log("Loading current accounts for CIF ID:",t),this.collateralService.getCurrentAccountsByCifId(t).subscribe({next:r=>{console.log("Current Accounts Received:",r),this.currentAccounts=r||[],this.cdr.detectChanges(),r&&r.length>0?(this.loanForm.patchValue({currentAccountId:r[0].id}),console.log("Set currentAccountId to:",r[0].id)):(this.errorMessage="No current accounts found for this CIF ID.",this.loanForm.get("currentAccountId")?.setErrors({noAccounts:!0}),console.log("No current accounts available"))},error:r=>{this.errorMessage="Failed to load current accounts: "+r.message,console.error("Error loading current accounts:",r)}})}loadCollaterals(t){this.collateralService.getCollateralsByCifId(t).subscribe({next:r=>{this.collaterals=r;const o=this.loanForm.get("collaterals");o.clear(),o.push(this.createCollateralGroup())},error:r=>this.errorMessage="Failed to load collaterals: "+r.message})}updateTotalCollateralAmount(){const t=this.totalCollateralAmount,r=Number(this.loanForm.get("loanAmount")?.value);this.errorMessage=r&&r>t?"Loan amount cannot exceed total collateral amount: "+t.toLocaleString():null}onSubmit(){if(this.loanForm.valid&&this.collateralControls.every(t=>t.valid)){const t=this.loanForm.value;console.log("Form Value:",t);const r=this.totalCollateralAmount;if(Number(t.loanAmount)>r)return void(this.errorMessage="Loan amount cannot exceed total collateral amount: "+r.toLocaleString());const o={loanAmount:Number(t.loanAmount),interestRate:Number(t.interestRate),gracePeriod:Number(t.gracePeriod),repaymentDuration:Number(t.repaymentDuration),documentFee:Number(t.documentFee),serviceCharges:Number(t.serviceCharges),status:t.status,dueDate:t.dueDate||void 0,repaymentStartDate:t.repaymentStartDate||void 0,currentAccountId:Number(t.currentAccountId)},a=t.collaterals.filter(c=>c.collateralId&&Number(c.collateralId)>0).map(c=>{const d=Number(c.collateralId),m=this.collaterals.find(p=>p.id===d);return console.log("Collateral ID from form:",d,"Found Collateral:",m),{collateralId:d,collateralAmount:m?Number(m.value):0}});if(0===a.length)return void(this.errorMessage="At least one valid collateral is required.");const s={loan:o,collaterals:a};console.log("Request Payload:",JSON.stringify(s)),this.loanService.registerLoan(s).subscribe({next:()=>{this.showSuccessMessage=!0,setTimeout(()=>{this.showSuccessMessage=!1,this.router.navigate(["/loans"])},2e3)},error:c=>this.errorMessage="Failed to register loan: "+c.message})}else this.errorMessage="Please fill all required fields correctly, including valid collaterals.",Object.keys(this.loanForm.controls).forEach(t=>{const r=this.loanForm.get(t);r?.invalid&&r.markAsTouched()}),this.loanForm.get("collaterals").controls.forEach(t=>{t.invalid&&t.markAsTouched()})}static{this.\u0275fac=function(r){return new(r||n)(e.rXU(l.ok),e.rXU(F.$),e.rXU(v.a),e.rXU(b.Ix),e.rXU(e.gRc))}}static{this.\u0275cmp=e.VBU({type:n,selectors:[["app-loan-create"]],decls:93,vars:22,consts:[[1,"container","mt-4"],["class","alert alert-success alert-dismissible fade show mb-3","role","alert",4,"ngIf"],["class","alert alert-danger mb-3","role","alert",4,"ngIf"],[1,"card","shadow-lg"],[1,"card-header","bg-primary","text-white"],[1,"mb-0"],[1,"card-body"],[3,"ngSubmit","formGroup"],[1,"mb-3"],[1,"form-label"],[1,"text-danger"],[1,"relative"],["type","text","placeholder","Search by CIF serial number",1,"form-control",3,"ngModelChange","input","click","blur","ngModel","ngModelOptions"],["class","absolute z-10 w-full bg-white border rounded shadow-lg max-h-48 overflow-y-auto",4,"ngIf"],["class","text-danger",4,"ngIf"],["formControlName","currentAccountId",1,"form-control"],["value",""],[3,"value",4,"ngFor","ngForOf"],["formArrayName","collaterals",1,"space-y-2"],["class","flex items-center space-x-2",3,"formGroupName",4,"ngFor","ngForOf"],[1,"mt-2"],["type","number","formControlName","loanAmount","placeholder","Enter loan amount","step","0.01",1,"form-control"],["type","number","formControlName","interestRate","placeholder","Enter interest rate","step","0.01",1,"form-control"],["type","number","formControlName","gracePeriod","placeholder","Enter grace period",1,"form-control"],["type","number","formControlName","repaymentDuration","placeholder","Enter repayment duration",1,"form-control"],["type","number","formControlName","documentFee","placeholder","Enter document fee","step","0.01",1,"form-control"],["type","number","formControlName","serviceCharges","placeholder","Enter service charges","step","0.01",1,"form-control"],["type","datetime-local","formControlName","dueDate",1,"form-control"],["type","datetime-local","formControlName","repaymentStartDate",1,"form-control"],[1,"text-end"],["type","submit",1,"btn","btn-primary",3,"disabled"],["role","alert",1,"alert","alert-success","alert-dismissible","fade","show","mb-3"],["type","button",1,"btn-close",3,"click"],["role","alert",1,"alert","alert-danger","mb-3"],[1,"absolute","z-10","w-full","bg-white","border","rounded","shadow-lg","max-h-48","overflow-y-auto"],["class","px-4 py-2 hover:bg-gray-100 cursor-pointer",3,"click",4,"ngFor","ngForOf"],["class","px-4 py-2 text-gray-500",4,"ngIf"],[1,"px-4","py-2","hover:bg-gray-100","cursor-pointer",3,"click"],[1,"px-4","py-2","text-gray-500"],[3,"value"],[1,"flex","items-center","space-x-2",3,"formGroupName"],["formControlName","collateralId",1,"form-control","w-2/3"],[1,"w-1/3","text-gray-600"],["type","button",1,"btn","btn-danger",3,"click","disabled"],["class","ml-2",4,"ngIf"],[1,"ml-2"],["type","button",1,"btn","btn-success",3,"click"]],template:function(r,o){if(1&r&&(e.j41(0,"div",0),e.DNE(1,k,3,0,"div",1)(2,E,2,1,"div",2),e.j41(3,"div",3)(4,"div",4)(5,"h4",5),e.EFF(6,"Register SME Loan"),e.k0s()(),e.j41(7,"div",6)(8,"form",7),e.bIt("ngSubmit",function(){return o.onSubmit()}),e.j41(9,"div",8)(10,"label",9),e.EFF(11,"CIF Serial Number "),e.j41(12,"span",10),e.EFF(13,"*"),e.k0s()(),e.j41(14,"div",11)(15,"input",12),e.mxI("ngModelChange",function(s){return e.DH7(o.cifSearchInput,s)||(o.cifSearchInput=s),s}),e.bIt("input",function(s){return o.filterCifs(s)})("click",function(){return o.toggleCifDropdown()})("blur",function(){return o.closeDropdowns()}),e.k0s(),e.DNE(16,N,3,2,"div",13),e.k0s(),e.DNE(17,j,2,0,"div",14),e.k0s(),e.j41(18,"div",8)(19,"label",9),e.EFF(20,"Current Account "),e.j41(21,"span",10),e.EFF(22,"*"),e.k0s()(),e.j41(23,"select",15)(24,"option",16),e.EFF(25,"-- Select Current Account --"),e.k0s(),e.DNE(26,R,2,2,"option",17),e.k0s(),e.DNE(27,A,2,0,"div",14),e.k0s(),e.j41(28,"div",8)(29,"label",9),e.EFF(30,"Collaterals "),e.j41(31,"span",10),e.EFF(32,"*"),e.k0s()(),e.j41(33,"div",18),e.DNE(34,S,11,7,"div",19)(35,T,2,0,"div",14),e.k0s(),e.j41(36,"div",20)(37,"strong"),e.EFF(38),e.nI1(39,"currency"),e.k0s()()(),e.j41(40,"div",8)(41,"label",9),e.EFF(42,"Loan Amount "),e.j41(43,"span",10),e.EFF(44,"*"),e.k0s()(),e.nrm(45,"input",21),e.DNE(46,G,2,0,"div",14),e.k0s(),e.j41(47,"div",8)(48,"label",9),e.EFF(49,"Interest Rate (%) "),e.j41(50,"span",10),e.EFF(51,"*"),e.k0s()(),e.nrm(52,"input",22),e.DNE(53,w,2,0,"div",14),e.k0s(),e.j41(54,"div",8)(55,"label",9),e.EFF(56,"Grace Period (days) "),e.j41(57,"span",10),e.EFF(58,"*"),e.k0s()(),e.nrm(59,"input",23),e.DNE(60,O,2,0,"div",14),e.k0s(),e.j41(61,"div",8)(62,"label",9),e.EFF(63,"Repayment Duration (months) "),e.j41(64,"span",10),e.EFF(65,"*"),e.k0s()(),e.nrm(66,"input",24),e.DNE(67,$,2,0,"div",14),e.k0s(),e.j41(68,"div",8)(69,"label",9),e.EFF(70,"Document Fee "),e.j41(71,"span",10),e.EFF(72,"*"),e.k0s()(),e.nrm(73,"input",25),e.DNE(74,P,2,0,"div",14),e.k0s(),e.j41(75,"div",8)(76,"label",9),e.EFF(77,"Service Charges "),e.j41(78,"span",10),e.EFF(79,"*"),e.k0s()(),e.nrm(80,"input",26),e.DNE(81,Y,2,0,"div",14),e.k0s(),e.j41(82,"div",8)(83,"label",9),e.EFF(84,"Due Date"),e.k0s(),e.nrm(85,"input",27),e.k0s(),e.j41(86,"div",8)(87,"label",9),e.EFF(88,"Repayment Start Date"),e.k0s(),e.nrm(89,"input",28),e.k0s(),e.j41(90,"div",29)(91,"button",30),e.EFF(92," Register Loan "),e.k0s()()()()()()),2&r){let a,s,c,d,m,p,g,_,h;e.R7$(),e.Y8G("ngIf",o.showSuccessMessage),e.R7$(),e.Y8G("ngIf",o.errorMessage),e.R7$(6),e.Y8G("formGroup",o.loanForm),e.R7$(7),e.R50("ngModel",o.cifSearchInput),e.Y8G("ngModelOptions",e.lJ4(21,I)),e.R7$(),e.Y8G("ngIf",o.showCifDropdown),e.R7$(),e.Y8G("ngIf",(null==(a=o.loanForm.get("cifId"))?null:a.touched)&&(null==(a=o.loanForm.get("cifId"))?null:a.invalid)),e.R7$(9),e.Y8G("ngForOf",o.currentAccounts),e.R7$(),e.Y8G("ngIf",(null==(s=o.loanForm.get("currentAccountId"))?null:s.touched)&&(null==(s=o.loanForm.get("currentAccountId"))?null:s.invalid)),e.R7$(7),e.Y8G("ngForOf",o.collateralControls),e.R7$(),e.Y8G("ngIf",(null==(c=o.loanForm.get("collaterals"))?null:c.touched)&&(null==(c=o.loanForm.get("collaterals"))?null:c.invalid)),e.R7$(3),e.SpI("Total Collateral Amount: ",e.bMT(39,19,o.totalCollateralAmount),""),e.R7$(8),e.Y8G("ngIf",(null==(d=o.loanForm.get("loanAmount"))?null:d.touched)&&(null==(d=o.loanForm.get("loanAmount"))?null:d.invalid)),e.R7$(7),e.Y8G("ngIf",(null==(m=o.loanForm.get("interestRate"))?null:m.touched)&&(null==(m=o.loanForm.get("interestRate"))?null:m.invalid)),e.R7$(7),e.Y8G("ngIf",(null==(p=o.loanForm.get("gracePeriod"))?null:p.touched)&&(null==(p=o.loanForm.get("gracePeriod"))?null:p.invalid)),e.R7$(7),e.Y8G("ngIf",(null==(g=o.loanForm.get("repaymentDuration"))?null:g.touched)&&(null==(g=o.loanForm.get("repaymentDuration"))?null:g.invalid)),e.R7$(7),e.Y8G("ngIf",(null==(_=o.loanForm.get("documentFee"))?null:_.touched)&&(null==(_=o.loanForm.get("documentFee"))?null:_.invalid)),e.R7$(7),e.Y8G("ngIf",(null==(h=o.loanForm.get("serviceCharges"))?null:h.touched)&&(null==(h=o.loanForm.get("serviceCharges"))?null:h.invalid)),e.R7$(10),e.Y8G("disabled",o.loanForm.invalid)}},dependencies:[f.MD,f.Sq,f.bT,f.oe,l.X1,l.qT,l.xH,l.y7,l.me,l.Q0,l.wz,l.BC,l.cb,l.j4,l.JD,l.$R,l.v8,l.YN,l.vS],styles:[".dropdown-container[_ngcontent-%COMP%]{position:relative}.dropdown-items[_ngcontent-%COMP%]{max-height:200px;overflow-y:auto}.space-y-2[_ngcontent-%COMP%] > *[_ngcontent-%COMP%] + *[_ngcontent-%COMP%]{margin-top:.5rem}.btn-danger[_ngcontent-%COMP%]:disabled{background-color:#dc3545;opacity:.6}.relative[_ngcontent-%COMP%]{position:relative}.absolute[_ngcontent-%COMP%]{position:absolute}.max-h-48[_ngcontent-%COMP%]{max-height:12rem}"]})}}return n})()}}]);