<div class="container my-5">
  <!-- Loading/Error State -->
  <div *ngIf="loading || errorMessage" class="text-center my-5">
    <div *ngIf="loading" class="spinner-border text-primary" role="status">
      <span class="visually-hidden">Loading...</span>
    </div>
    <p *ngIf="errorMessage" class="text-danger mt-3">{{ errorMessage }}</p>
  </div>

  <!-- Main Content -->
  <div *ngIf="!loading && branch" class="row">
    <!-- Branch Info Card (Left Sidebar) -->
    <div class="col-lg-4 mb-4">
      <div class="card shadow-sm">
        <div class="card-header bg-primary text-white d-flex justify-content-between align-items-center">
          <h4 class="mb-0"><i class="bi bi-building me-2"></i>Branch Overview</h4>
          <button class="btn btn-light btn-sm" (click)="goBack()">
            <i class="bi bi-arrow-left"></i> Back
          </button>
        </div>
        <div class="card-body">
          <ul class="list-group list-group-flush">
            <li class="list-group-item"><strong>Code:</strong> {{ branch.branchCode }}</li>
            <li class="list-group-item"><strong>Name:</strong> {{ branch.branchName }}</li>
            <li class="list-group-item"><strong>Phone:</strong> {{ branch.phoneNumber }}</li>
            <li class="list-group-item"><strong>Email:</strong> {{ branch.email }}</li>
            <li class="list-group-item">
              <strong>Address:</strong> 
              {{ branch.address?.region || 'N/A' }}, 
              {{ branch.address?.district || 'N/A' }}, 
              {{ branch.address?.township || 'N/A' }}
            </li>
            <li class="list-group-item">
              <strong>Status:</strong> 
              <span [ngClass]="{'text-success': branch.status === 1, 'text-danger': branch.status === 0}">
                {{ branch.status === 1 ? 'Active' : 'Inactive' }}
              </span>
            </li>
          </ul>
        </div>
      </div>
    </div>

    <!-- Details Sections (Right Content) -->
    <div class="col-lg-8">
      <!-- Accordion for Details -->
      <div class="accordion" id="branchDetailsAccordion">
        
        <!-- CIFs -->
        <div class="accordion-item shadow-sm mb-3">
          <h2 class="accordion-header">
            <button class="accordion-button" type="button" data-bs-toggle="collapse" data-bs-target="#cifsCollapse">
              <i class="bi bi-person-lines-fill me-2"></i> CIFs ({{ branch.totalCifs || 0 }})
            </button>
          </h2>
          <div id="cifsCollapse" class="accordion-collapse collapse show" data-bs-parent="#branchDetailsAccordion">
            <div class="accordion-body">
              <table class="table table-striped table-hover">
                <thead class="table-dark">
                  <tr>
                    <th>ID</th>
                    <th>Name</th>
                    <th>NRC Number</th>
                    <th>Phone</th>
                  </tr>
                </thead>
                <tbody>
                  <tr *ngFor="let cif of branch.recentCifs || []">
                    <td>{{ cif.id }}</td>
                    <td>{{ cif.name }}</td>
                    <td>{{ cif.nrcNumber }}</td>
                    <td>{{ cif.phoneNumber }}</td>
                  </tr>
                  <tr *ngIf="!branch.recentCifs || branch.recentCifs.length === 0">
                    <td colspan="4" class="text-center">No recent CIFs</td>
                  </tr>
                </tbody>
              </table>
            </div>
          </div>
        </div>

        <!-- Current Accounts -->
        <div class="accordion-item shadow-sm mb-3">
          <h2 class="accordion-header">
            <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#accountsCollapse">
              <i class="bi bi-bank me-2"></i> Current Accounts ({{ branch.totalCurrentAccounts || 0 }})
            </button>
          </h2>
          <div id="accountsCollapse" class="accordion-collapse collapse" data-bs-parent="#branchDetailsAccordion">
            <div class="accordion-body">
              <table class="table table-striped table-hover">
                <thead class="table-dark">
                  <tr>
                    <th>ID</th>
                    <th>Account Number</th>
                    <th>Balance</th>
                    <th>Status</th>
                  </tr>
                </thead>
                <tbody>
                  <tr *ngFor="let account of branch.recentCurrentAccounts || []">
                    <td>{{ account.id }}</td>
                    <td>{{ account.accountNumber }}</td>
                    <td>{{ account.balance }}</td>
                    <td>
                      <span [ngClass]="{'text-success': account.status === 1, 'text-danger': account.status === 0}">
                        {{ account.status === 1 ? 'Active' : 'Inactive' }}
                      </span>
                    </td>
                  </tr>
                  <tr *ngIf="!branch.recentCurrentAccounts || branch.recentCurrentAccounts.length === 0">
                    <td colspan="4" class="text-center">No recent accounts</td>
                  </tr>
                </tbody>
              </table>
            </div>
          </div>
        </div>

        <!-- Transactions -->
        <div class="accordion-item shadow-sm mb-3">
          <h2 class="accordion-header">
            <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#transactionsCollapse">
              <i class="bi bi-arrow-left-right me-2"></i> Transactions ({{ branch.totalTransactions || 0 }})
            </button>
          </h2>
          <div id="transactionsCollapse" class="accordion-collapse collapse" data-bs-parent="#branchDetailsAccordion">
            <div class="accordion-body">
              <table class="table table-striped table-hover">
                <thead class="table-dark">
                  <tr>
                    <th>ID</th>
                    <th>Type</th>
                    <th>Amount</th>
                    <th>Date</th>
                  </tr>
                </thead>
                <tbody>
                  <tr *ngFor="let transaction of branch.recentTransactions || []">
                    <td>{{ transaction.id }}</td>
                    <td>{{ transaction.transactionType }}</td>
                    <td>{{ transaction.amount }}</td>
                    <td>{{ transaction.transactionDate | date }}</td>
                  </tr>
                  <tr *ngIf="!branch.recentTransactions || branch.recentTransactions.length === 0">
                    <td colspan="4" class="text-center">No recent transactions</td>
                  </tr>
                </tbody>
              </table>
            </div>
          </div>
        </div>

        <!-- Collaterals -->
        <div class="accordion-item shadow-sm mb-3">
          <h2 class="accordion-header">
            <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collateralsCollapse">
              <i class="bi bi-shield-check me-2"></i> Collaterals ({{ branch.totalCollaterals || 0 }})
            </button>
          </h2>
          <div id="collateralsCollapse" class="accordion-collapse collapse" data-bs-parent="#branchDetailsAccordion">
            <div class="accordion-body">
              <table class="table table-striped table-hover">
                <thead class="table-dark">
                  <tr>
                    <th>ID</th>
                    <th>Description</th>
                    <th>Value</th>
                    <th>Status</th>
                  </tr>
                </thead>
                <tbody>
                  <tr *ngFor="let collateral of branch.recentCollaterals || []">
                    <td>{{ collateral.id }}</td>
                    <td>{{ collateral.description }}</td>
                    <td>{{ collateral.value }}</td>
                    <td>
                      <span [ngClass]="{'text-success': collateral.status === 1, 'text-danger': collateral.status === 0}">
                        {{ collateral.status === 1 ? 'Active' : 'Inactive' }}
                      </span>
                    </td>
                  </tr>
                  <tr *ngIf="!branch.recentCollaterals || branch.recentCollaterals.length === 0">
                    <td colspan="4" class="text-center">No recent collaterals</td>
                  </tr>
                </tbody>
              </table>
            </div>
          </div>
        </div>

        <!-- Dealers -->
        <div class="accordion-item shadow-sm mb-3">
          <h2 class="accordion-header">
            <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#dealersCollapse">
              <i class="bi bi-shop me-2"></i> Dealers ({{ branch.totalDealers || 0 }})
            </button>
          </h2>
          <div id="dealersCollapse" class="accordion-collapse collapse" data-bs-parent="#branchDetailsAccordion">
            <div class="accordion-body">
              <table class="table table-striped table-hover">
                <thead class="table-dark">
                  <tr>
                    <th>ID</th>
                    <th>Company Name</th>
                    <th>Phone</th>
                    <th>Registration Date</th>
                  </tr>
                </thead>
                <tbody>
                  <tr *ngFor="let dealer of branch.recentDealers || []">
                    <td>{{ dealer.id }}</td>
                    <td>{{ dealer.companyName }}</td>
                    <td>{{ dealer.phoneNumber }}</td>
                    <td>{{ dealer.registrationDate | date }}</td>
                  </tr>
                  <tr *ngIf="!branch.recentDealers || branch.recentDealers.length === 0">
                    <td colspan="4" class="text-center">No recent dealers</td>
                  </tr>
                </tbody>
              </table>
            </div>
          </div>
        </div>

        <!-- SME Loans -->
        <div class="accordion-item shadow-sm mb-3">
          <h2 class="accordion-header">
            <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#smeLoansCollapse">
              <i class="bi bi-cash-stack me-2"></i> SME Loans ({{ branch.ongoingSmeLoans || 0 }})
            </button>
          </h2>
          <div id="smeLoansCollapse" class="accordion-collapse collapse" data-bs-parent="#branchDetailsAccordion">
            <div class="accordion-body">
              <table class="table table-striped table-hover">
                <thead class="table-dark">
                  <tr>
                    <th>ID</th>
                    <th>Serial Code</th>
                    <th>Loan Amount</th>
                    <th>Status</th>
                  </tr>
                </thead>
                <tbody>
                  <tr *ngFor="let loan of branch.recentSmeLoans || []">
                    <td>{{ loan.id }}</td>
                    <td>{{ loan.serialCode }}</td>
                    <td>{{ loan.loanAmount }}</td>
                    <td>
                      <span [ngClass]="{'text-success': loan.status === 1, 'text-danger': loan.status === 0}">
                        {{ loan.status === 1 ? 'Active' : 'Inactive' }}
                      </span>
                    </td>
                  </tr>
                  <tr *ngIf="!branch.recentSmeLoans || branch.recentSmeLoans.length === 0">
                    <td colspan="4" class="text-center">No recent SME loans</td>
                  </tr>
                </tbody>
              </table>
            </div>
          </div>
        </div>

        <!-- HP Loans -->
        <div class="accordion-item shadow-sm mb-3">
          <h2 class="accordion-header">
            <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#hpLoansCollapse">
              <i class="bi bi-truck me-2"></i> HP Loans ({{ branch.ongoingHpLoans || 0 }})
            </button>
          </h2>
          <div id="hpLoansCollapse" class="accordion-collapse collapse" data-bs-parent="#branchDetailsAccordion">
            <div class="accordion-body">
              <table class="table table-striped table-hover">
                <thead class="table-dark">
                  <tr>
                    <th>ID</th>
                    <th>HP Number</th>
                    <th>Loan Amount</th>
                    <th>Status</th>
                  </tr>
                </thead>
                <tbody>
                  <tr *ngFor="let loan of branch.recentHpLoans || []">
                    <td>{{ loan.id }}</td>
                    <td>{{ loan.hpNumber }}</td>
                    <td>{{ loan.loanAmount }}</td>
                    <td>
                      <span [ngClass]="{'text-success': loan.status === 1, 'text-danger': loan.status === 0}">
                        {{ loan.status === 1 ? 'Active' : 'Inactive' }}
                      </span>
                    </td>
                  </tr>
                  <tr *ngIf="!branch.recentHpLoans || branch.recentHpLoans.length === 0">
                    <td colspan="4" class="text-center">No recent HP loans</td>
                  </tr>
                </tbody>
              </table>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>