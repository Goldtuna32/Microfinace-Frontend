<div class="collateral-container">
  <!-- Success Message -->
  <div *ngIf="showSuccessMessage" class="alert alert-success alert-dismissible fade show mb-4" role="alert">
    <i class="bi bi-check-circle-fill"></i>
    <div>
      <h5 class="alert-heading mb-1">Success!</h5>
      <p class="mb-0">Collateral created successfully!</p>
    </div>
    <button type="button" class="btn-close" (click)="showSuccessMessage = false"></button>
  </div>

  <div class="collateral-card">
    <!-- Card Header -->
    <div class="card-header text-white">
      <h4>
        <i class="bi bi-file-earmark-lock-fill"></i> Create New Collateral
      </h4>
    </div>

    <!-- Card Body -->
    <div class="card-body">
      <form [formGroup]="collateralForm" (ngSubmit)="onSubmit()">
        <!-- CIF Selection by Serial Number -->
        <div class="form-section">
          <label class="form-label">
            <i class="bi bi-person-badge"></i> Search CIF by Serial Number <span class="required-star">*</span>
          </label>
          <div class="dropdown-container">
            <input
              type="text"
              class="form-control"
              placeholder="Enter CIF serial number"
              [(ngModel)]="cifSearchInput"
              (input)="filterCifsBySerialNumber($event)"
              (click)="toggleCifDropdown()"
              (blur)="closeDropdowns()"
              [ngModelOptions]="{standalone: true}"
            >
            <div *ngIf="showCifDropdown" class="dropdown-menu show">
              <div class="dropdown-items">
                <div *ngFor="let cif of filteredCifs" 
                     class="dropdown-item" 
                     (click)="selectCif(cif)">
                  <div class="fw-semibold">{{ cif.serialNumber }}</div>
                  <div class="text-muted">{{ cif.name }}</div>
                </div>
                <div *ngIf="filteredCifs.length === 0" class="dropdown-item text-muted">
                  <i class="bi bi-search me-2"></i> No matching CIFs found
                </div>
              </div>
            </div>
          </div>
          <div *ngIf="collateralForm.get('cifId')?.touched && collateralForm.get('cifId')?.invalid" class="error-text">
            <i class="bi bi-exclamation-circle-fill"></i> CIF is required
          </div>
        </div>

        <!-- Collateral Type Selection -->
        <div class="form-section">
          <label class="form-label">
            <i class="bi bi-tags"></i> Select Collateral Type <span class="required-star">*</span>
          </label>
          <div class="dropdown-container">
            <input
              type="text"
              class="form-control"
              placeholder="Search collateral type by name"
              [(ngModel)]="collateralTypeSearchInput"
              (input)="filterCollateralTypes($event)"
              (click)="toggleCollateralTypeDropdown()"
              (blur)="closeDropdowns()"
              [ngModelOptions]="{standalone: true}"
            >
            <div *ngIf="showCollateralTypeDropdown" class="dropdown-menu show">
              <div class="dropdown-items">
                <div *ngFor="let type of filteredCollateralTypes" 
                     class="dropdown-item" 
                     (click)="selectCollateralType(type)">
                  {{ type.name }}
                </div>
                <div *ngIf="filteredCollateralTypes.length === 0" class="dropdown-item text-muted">
                  <i class="bi bi-search me-2"></i> No matching collateral types found
                </div>
              </div>
            </div>
          </div>
          <div *ngIf="collateralForm.get('collateralTypeId')?.touched && collateralForm.get('collateralTypeId')?.invalid" class="error-text">
            <i class="bi bi-exclamation-circle-fill"></i> Collateral Type is required
          </div>
        </div>

        <!-- Collateral Value -->
        <div class="form-section">
          <label class="form-label">
            <i class="bi bi-cash-stack"></i> Value <span class="required-star">*</span>
          </label>
          <div class="input-group">
            <span class="input-group-text">
              <i class="bi bi-currency-dollar"></i>
            </span>
            <input
              type="number"
              class="form-control"
              formControlName="value"
              placeholder="Enter collateral value"
              step="0.01"
              min="0"
            >
          </div>
          <div *ngIf="collateralForm.get('value')?.touched && collateralForm.get('value')?.invalid" class="error-text">
            <i class="bi bi-exclamation-circle-fill"></i> 
            <span *ngIf="collateralForm.get('value')?.errors?.['required']">Value is required</span>
            <span *ngIf="collateralForm.get('value')?.errors?.['min']">Value must be greater than 0</span>
          </div>
        </div>

        <!-- Description -->
        <div class="form-section">
          <label class="form-label">
            <i class="bi bi-card-text"></i> Description <span class="required-star">*</span>
          </label>
          <textarea
            class="form-control"
            formControlName="description"
            rows="3"
            placeholder="Enter collateral description"
          ></textarea>
          <div *ngIf="collateralForm.get('description')?.touched && collateralForm.get('description')?.invalid" class="error-text">
            <i class="bi bi-exclamation-circle-fill"></i> 
            <span *ngIf="collateralForm.get('description')?.errors?.['required']">Description is required</span>
            <span *ngIf="collateralForm.get('description')?.errors?.['maxlength']">Description must not exceed 1000 characters</span>
          </div>
        </div>

        <!-- Photos Section -->
        <div class="row">
          <!-- Front Collateral Photo -->
          <div class="col-md-6 form-section">
            <label class="form-label">
              <i class="bi bi-camera"></i> Front Photo <span class="required-star">*</span>
            </label>
            <div class="file-input-group">
              <label class="file-label" for="frontPhotoInput">
                <span>
                  <i class="bi bi-upload me-2"></i>
                  {{ frontPhotoPreview ? 'Change Front Photo' : 'Upload Front Photo' }}
                </span>
                <i class="bi bi-image"></i>
              </label>
              <input
                type="file"
                class="file-input"
                id="frontPhotoInput"
                (change)="onFrontPhotoSelected($event)"
                accept="image/*"
                #frontPhotoInput
              >
            </div>
            <div *ngIf="frontPhotoPreview" class="image-preview mt-2">
              <img [src]="frontPhotoPreview" class="img-fluid rounded">
              <button type="button" class="btn btn-sm btn-danger mt-2" (click)="removeFrontPhoto()">
                <i class="bi bi-trash"></i> Remove
              </button>
            </div>
            <div *ngIf="collateralForm.get('F_collateralPhoto')?.touched && collateralForm.get('F_collateralPhoto')?.invalid" class="error-text">
              <i class="bi bi-exclamation-circle-fill"></i> Front photo is required
            </div>
          </div>

          <!-- Back Collateral Photo -->
          <div class="col-md-6 form-section">
            <label class="form-label">
              <i class="bi bi-camera-reels"></i> Back Photo <span class="required-star">*</span>
            </label>
            <div class="file-input-group">
              <label class="file-label" for="backPhotoInput">
                <span>
                  <i class="bi bi-upload me-2"></i>
                  {{ backPhotoPreview ? 'Change Back Photo' : 'Upload Back Photo' }}
                </span>
                <i class="bi bi-image"></i>
              </label>
              <input
                type="file"
                class="file-input"
                id="backPhotoInput"
                (change)="onBackPhotoSelected($event)"
                accept="image/*"
                #backPhotoInput
              >
            </div>
            <div *ngIf="backPhotoPreview" class="image-preview mt-2">
              <img [src]="backPhotoPreview" class="img-fluid rounded">
              <button type="button" class="btn btn-sm btn-danger mt-2" (click)="removeBackPhoto()">
                <i class="bi bi-trash"></i> Remove
              </button>
            </div>
            <div *ngIf="collateralForm.get('B_collateralPhoto')?.touched && collateralForm.get('B_collateralPhoto')?.invalid" class="error-text">
              <i class="bi bi-exclamation-circle-fill"></i> Back photo is required
            </div>
          </div>
        </div>

        <!-- Submit Button -->
        <div class="text-end mt-4">
          <button 
            type="submit" 
            class="btn btn-primary btn-submit" 
            [disabled]="collateralForm.invalid"
            [class.pulse-animation]="collateralForm.valid"
          >
            <i class="bi bi-save-fill me-2"></i> Create Collateral
          </button>
        </div>
      </form>
    </div>
  </div>
</div>