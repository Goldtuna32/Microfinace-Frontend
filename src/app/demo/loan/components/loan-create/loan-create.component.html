<div class="container-fluid py-4 animate__animated animate__fadeIn">
  <!-- Success Message with animation -->
  <div *ngIf="showSuccessMessage" class="alert alert-success alert-dismissible fade show mb-4 animate__animated animate__bounceIn" role="alert">
    <div class="d-flex align-items-center">
      <i class="bi bi-check-circle-fill me-2 fs-4"></i>
      <div>
        <strong>Success!</strong> Loan registered successfully.
      </div>
      <button type="button" class="btn-close ms-auto" (click)="showSuccessMessage = false"></button>
    </div>
  </div>

  <!-- Error Message -->
  <div *ngIf="errorMessage" class="alert alert-danger alert-dismissible fade show mb-4 animate__animated animate__shakeX" role="alert">
    <div class="d-flex align-items-center">
      <i class="bi bi-exclamation-triangle-fill me-2 fs-4"></i>
      <div>{{ errorMessage }}</div>
      <button type="button" class="btn-close ms-auto" (click)="errorMessage = ''"></button>
    </div>
  </div>

  <div class="card border-0 shadow-lg animate__animated animate__zoomIn">
    <!-- Card Header with gradient background -->
    <div class="card-header bg-primary bg-gradient text-white py-3">
      <div class="d-flex justify-content-between align-items-center">
        <h4 class="m-0">
          <i class="bi bi-file-earmark-text me-2"></i> SME Loan Registration
        </h4>
        <button class="btn btn-light btn-sm" routerLink="/loans">
          <i class="bi bi-arrow-left me-1"></i> Back to Loans
        </button>
      </div>
    </div>

    <div class="card-body p-4 p-md-5">
      <form [formGroup]="loanForm" (ngSubmit)="onSubmit()" class="needs-validation" novalidate>
        <div class="row g-4">
          <!-- CIF Search -->
          <div class="col-md-6">
            <label class="form-label fw-bold">
              <i class="bi bi-person-badge text-primary me-1"></i> CIF Serial Number <span class="text-danger">*</span>
            </label>
            <div class="dropdown-container">
              <div class="input-group has-validation">
                <span class="input-group-text bg-light"><i class="bi bi-search"></i></span>
                <input
                  type="text"
                  class="form-control"
                  placeholder="Search by CIF serial number"
                  [(ngModel)]="cifSearchInput"
                  (input)="filterCifs($event)"
                  (click)="toggleCifDropdown()"
                  (blur)="closeDropdowns()"
                  [ngModelOptions]="{standalone: true}"
                >
              </div>
              <div *ngIf="showCifDropdown" class="dropdown-menu show w-100 mt-1 shadow animate__animated animate__fadeIn">
                <div class="dropdown-items">
                  <div *ngFor="let cif of filteredCifs" 
                       class="dropdown-item d-flex justify-content-between align-items-center"
                       (click)="selectCif(cif)">
                    <div>
                      <strong>{{ cif.serialNumber }}</strong> - {{ cif.name }}
                    </div>
                    <i class="bi bi-chevron-right text-muted"></i>
                  </div>
                  <div *ngIf="filteredCifs.length === 0" class="dropdown-item text-muted">
                    <i class="bi bi-exclamation-circle me-2"></i>No matching CIFs found
                  </div>
                </div>
              </div>
              <div *ngIf="loanForm.get('cifId')?.touched && loanForm.get('cifId')?.invalid"
                   class="invalid-feedback d-block animate__animated animate__fadeIn">
                <i class="bi bi-exclamation-circle me-1"></i>CIF is required
              </div>
            </div>
          </div>

          <!-- Current Account Selection -->
          <div class="col-md-6">
            <label class="form-label fw-bold">
              <i class="bi bi-bank text-primary me-1"></i> Current Account <span class="text-danger">*</span>
            </label>
            <select class="form-select" formControlName="currentAccountId">
              <option value="">-- Select Current Account --</option>
              <option *ngFor="let account of currentAccounts" [value]="account.id">
                {{ account.accountNumber }} ({{ account.balance | currency }})
              </option>
            </select>
            <div *ngIf="loanForm.get('currentAccountId')?.touched && loanForm.get('currentAccountId')?.invalid"
                 class="invalid-feedback d-block animate__animated animate__fadeIn">
              <i class="bi bi-exclamation-circle me-1"></i>Current account is required
            </div>
          </div>

          <!-- Collaterals Section -->
          <div class="col-12">
            <div class="border-top pt-3 mb-3">
              <h5 class="fw-bold text-primary">
                <i class="bi bi-shield-lock me-2"></i> Collaterals
              </h5>
            </div>
            
            <div formArrayName="collaterals" class="row g-3">
              <div *ngFor="let collateral of collateralControls; let i=index" [formGroupName]="i" 
                   class="col-12 animate__animated animate__fadeInUp">
                <div class="card border-0 shadow-sm">
                  <div class="card-body">
                    <div class="row align-items-center">
                      <div class="col-md-6 mb-2 mb-md-0">
                        <label class="form-label">Collateral <span class="text-danger">*</span></label>
                        <select class="form-select" formControlName="collateralId">
                          <option value="">-- Select Collateral --</option>
                          <option *ngFor="let coll of getAvailableCollaterals(i)" [value]="coll.id">
                            {{ coll.description }} ({{ coll.value | currency }})
                          </option>
                        </select>
                      </div>
                      <div class="col-md-4 mb-2 mb-md-0">
                        <label class="form-label">Value</label>
                        <div class="input-group">
                          <span class="input-group-text bg-light">$</span>
                          <input type="text" class="form-control bg-light" readonly 
                                 [value]="getCollateralValue(collateral) | currency">
                        </div>
                      </div>
                      <div class="col-md-2 d-flex justify-content-end">
                        <button type="button" class="btn btn-outline-danger me-2" 
                                (click)="removeCollateral(i)"
                                [disabled]="collateralControls.length === 1"
                                matTooltip="Remove Collateral">
                          <i class="bi bi-trash"></i>
                        </button>
                        <button *ngIf="i === collateralControls.length - 1" 
                                type="button" class="btn btn-outline-success"
                                (click)="addCollateral()"
                                matTooltip="Add Collateral">
                          <i class="bi bi-plus-lg"></i>
                        </button>
                      </div>
                    </div>
                  </div>
                </div>
              </div>
              
              <div *ngIf="loanForm.get('collaterals')?.touched && loanForm.get('collaterals')?.invalid"
                   class="invalid-feedback d-block animate__animated animate__fadeIn">
                <i class="bi bi-exclamation-circle me-1"></i>At least one valid collateral is required
              </div>
              
              <div class="col-12 mt-2">
                <div class="alert alert-info">
                  <div class="d-flex justify-content-between align-items-center">
                    <div>
                      <i class="bi bi-info-circle-fill me-2"></i>
                      <strong>Total Collateral Amount:</strong> {{ totalCollateralAmount | currency }}
                    </div>
                    <span class="badge bg-primary rounded-pill">
                      LTV: {{ calculateLTV() | percent:'1.2-2' }}
                    </span>
                  </div>
                </div>
              </div>
            </div>
          </div>

          <!-- Loan Details Section -->
          <div class="col-12">
            <div class="border-top pt-3 mb-3">
              <h5 class="fw-bold text-primary">
                <i class="bi bi-cash-stack me-2"></i> Loan Details
              </h5>
            </div>
          </div>

          <!-- Loan Amount -->
          <div class="col-md-4">
            <label class="form-label fw-bold">Loan Amount <span class="text-danger">*</span></label>
            <div class="input-group has-validation">
              <span class="input-group-text bg-light">$</span>
              <input type="number" class="form-control" formControlName="loanAmount"
                     placeholder="0.00" step="0.01">
            </div>
            <div *ngIf="loanForm.get('loanAmount')?.touched && loanForm.get('loanAmount')?.invalid"
                 class="invalid-feedback d-block animate__animated animate__fadeIn">
              <i class="bi bi-exclamation-circle me-1"></i>Loan amount must be greater than 0
            </div>
          </div>

          <!-- Interest Rate -->
          <div class="col-md-4">
            <label class="form-label fw-bold">Interest Rate <span class="text-danger">*</span></label>
            <div class="input-group has-validation">
              <span class="input-group-text bg-light">%</span>
              <input type="number" class="form-control" formControlName="interestRate"
                     placeholder="0.00" step="0.01">
            </div>
            <div *ngIf="loanForm.get('interestRate')?.touched && loanForm.get('interestRate')?.invalid"
                 class="invalid-feedback d-block animate__animated animate__fadeIn">
              <i class="bi bi-exclamation-circle me-1"></i>Interest rate must be greater than 0
            </div>
          </div>

          <!-- Repayment Duration -->
          <div class="col-md-4">
            <label class="form-label fw-bold">Term (months) <span class="text-danger">*</span></label>
            <div class="input-group has-validation">
              <span class="input-group-text bg-light"><i class="bi bi-calendar-month"></i></span>
              <input type="number" class="form-control" formControlName="repaymentDuration"
                     placeholder="12">
            </div>
            <div *ngIf="loanForm.get('repaymentDuration')?.touched && loanForm.get('repaymentDuration')?.invalid"
                 class="invalid-feedback d-block animate__animated animate__fadeIn">
              <i class="bi bi-exclamation-circle me-1"></i>Term must be greater than 0
            </div>
          </div>

          <!-- Late Fee Rates Section -->
          <div class="col-12">
            <div class="border-top pt-3 mb-3">
              <h5 class="fw-bold text-primary">
                <i class="bi bi-clock-history me-2"></i> Late Fee Rates
              </h5>
            </div>
          </div>

          <!-- Late Fee Rates -->
          <div class="col-md-4">
            <label class="form-label">Standard Late Fee <span class="text-danger">*</span></label>
            <div class="input-group">
              <span class="input-group-text bg-light">%</span>
              <input type="number" class="form-control" formControlName="late_fee_rate"
                     placeholder="0.00" step="0.01">
            </div>
          </div>

          <div class="col-md-4">
            <label class="form-label">90-Day Late Fee <span class="text-danger">*</span></label>
            <div class="input-group">
              <span class="input-group-text bg-light">%</span>
              <input type="number" class="form-control" formControlName="ninety_day_late_fee_rate"
                     placeholder="0.00" step="0.01">
            </div>
          </div>

          <div class="col-md-4">
            <label class="form-label">180-Day Late Fee <span class="text-danger">*</span></label>
            <div class="input-group">
              <span class="input-group-text bg-light">%</span>
              <input type="number" class="form-control" formControlName="one_hundred_and_eighty_late_fee_rate"
                     placeholder="0.00" step="0.01">
            </div>
          </div>

          <!-- Other Details Section -->
          <div class="col-12">
            <div class="border-top pt-3 mb-3">
              <h5 class="fw-bold text-primary">
                <i class="bi bi-gear me-2"></i> Additional Details
              </h5>
            </div>
          </div>

          <!-- Grace Period -->
          <div class="col-md-4">
            <label class="form-label">Grace Period <span class="text-danger">*</span></label>
            <div class="input-group">
              <span class="input-group-text bg-light"><i class="bi bi-calendar-check"></i></span>
              <input type="number" class="form-control" formControlName="gracePeriod"
                     placeholder="0">
              <span class="input-group-text bg-light">days</span>
            </div>
          </div>

          <!-- Document Fee -->
          <div class="col-md-4">
            <label class="form-label">Document Fee <span class="text-danger">*</span></label>
            <div class="input-group">
              <span class="input-group-text bg-light">$</span>
              <input type="number" class="form-control" formControlName="documentFee"
                     placeholder="0.00" step="0.01">
            </div>
          </div>

          <!-- Service Charges -->
          <div class="col-md-4">
            <label class="form-label">Service Charges <span class="text-danger">*</span></label>
            <div class="input-group">
              <span class="input-group-text bg-light">$</span>
              <input type="number" class="form-control" formControlName="serviceCharges"
                     placeholder="0.00" step="0.01">
            </div>
          </div>

         

          <!-- Submit Button -->
          <div class="col-12 mt-4">
            <div class="d-grid">
              <button type="submit" class="btn btn-primary btn-lg py-3 animate__animated animate__pulse animate__infinite animate__slower"
                      [disabled]="loanForm.invalid">
                <i class="bi bi-check-circle-fill me-2"></i> Register Loan
              </button>
            </div>
          </div>
        </div>
      </form>
    </div>
  </div>
</div>